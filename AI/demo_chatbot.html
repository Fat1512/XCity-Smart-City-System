<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Traffic Chatbot Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 12px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 16px;
      margin: 0;
    }
    header span {
      font-size: 12px;
      color: #9ca3af;
    }
    #chat {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: radial-gradient(circle at top, #0f172a 0, #020617 60%);
    }
    .msg {
      margin-bottom: 12px;
      max-width: 70%;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .user {
      margin-left: auto;
      background: #1d4ed8;
    }
    .bot {
      margin-right: auto;
      background: #111827;
      border: 1px solid #1f2937;
    }
    .meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    #input-bar {
      display: flex;
      padding: 10px;
      gap: 8px;
      border-top: 1px solid #1f2937;
      background: #020617;
    }
    #query {
      flex: 1;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      resize: none;
      font-family: inherit;
      font-size: 14px;
      height: 48px;
    }
    #send {
      border: none;
      border-radius: 6px;
      padding: 0 16px;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    #send:disabled {
      opacity: .6;
      cursor: default;
    }
    details {
      margin-top: 4px;
      font-size: 11px;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>Traffic & Route Chatbot</h1>
    <span>demo frontend</span>
  </header>

  <div id="chat"></div>

  <div id="input-bar">
    <textarea id="query" placeholder="Nhập câu hỏi...&#10;VD: Tính đường từ 10.77,106.68 tới 10.78,106.70&#10;VD: Tình hình giao thông hiện tại sao rồi?"></textarea>
    <button id="send">Gửi</button>
  </div>

  <script>
    // chỉnh URL này cho khớp backend của bạn
    const CHAT_ENDPOINT = "http://localhost:5000/api/v1/rag/chat";

    let conversationId = null;

    const chatEl = document.getElementById("chat");
    const queryEl = document.getElementById("query");
    const sendBtn = document.getElementById("send");

    function appendMessage(text, role = "bot", meta = "") {
      const wrapper = document.createElement("div");
      const msg = document.createElement("div");
      msg.className = "msg " + (role === "user" ? "user" : "bot");
      msg.textContent = text;
      wrapper.appendChild(msg);
      if (meta) {
        const metaEl = document.createElement("div");
        metaEl.className = "meta";
        metaEl.textContent = meta;
        wrapper.appendChild(metaEl);
      }
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function appendToolInfo(toolResult, trafficStats, trafficImages) {
      if (toolResult) {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = "Chi tiết route (GeoJSON)";
        const code = document.createElement("code");
        code.textContent = JSON.stringify(toolResult, null, 2);
        details.appendChild(summary);
        details.appendChild(code);
        const box = document.createElement("div");
        box.className = "msg bot";
        box.appendChild(details);
        chatEl.appendChild(box);
      }

      if (trafficStats) {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = "Traffic stats";
        const code = document.createElement("code");
        code.textContent = JSON.stringify(trafficStats, null, 2);
        details.appendChild(summary);
        details.appendChild(code);
        const box = document.createElement("div");
        box.className = "msg bot";
        box.appendChild(details);
        chatEl.appendChild(box);
      }

      if (trafficImages && trafficImages.length) {
        const box = document.createElement("div");
        box.className = "msg bot";
        const title = document.createElement("div");
        title.textContent = "Ảnh giao thông hiện tại:";
        box.appendChild(title);

        trafficImages.forEach(imgInfo => {
          const img = document.createElement("img");
          img.src = `data:${imgInfo.mime_type};base64,${imgInfo.image_base64}`;
          img.alt = imgInfo.stream_id;
          img.style.maxWidth = "200px";
          img.style.display = "block";
          img.style.marginTop = "4px";
          box.appendChild(img);
        });

        chatEl.appendChild(box);
      }

      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function sendQuery() {
      const text = queryEl.value.trim();
      if (!text) return;

      appendMessage(text, "user");
      queryEl.value = "";
      queryEl.focus();
      sendBtn.disabled = true;

      try {
        const res = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: text,
            conversation_id: conversationId
          })
        });

        if (!res.ok) {
          appendMessage("Lỗi gọi API: " + res.status, "bot");
        } else {
          const data = await res.json();
          if (data.conversation_id) {
            conversationId = data.conversation_id;
          }
          appendMessage(data.answer || "(không có nội dung)", "bot");
          appendToolInfo(data.tool_result, data.traffic_stats, data.traffic_images);
        }
      } catch (err) {
        console.error(err);
        appendMessage("Không gọi được API: " + err, "bot");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendQuery);
    queryEl.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendQuery();
      }
    });

    // chào nhẹ nhàng
    appendMessage("Xin chào, tôi có thể:\n- Tính đường (có/không kẹt xe) giữa hai tọa độ.\n- Mô tả tình trạng giao thông hiện tại (và gửi kèm hình).", "bot");
  </script>
</body>
</html>
